#!/usr/bin/env node
var ref$, reject, each, keys, map, elemIndex, findIndex, join, isType, compact, concat, range, name, version, fs, download, mkdirp, xlsxToJson, Excel, msg, readSpreadsheet, composeYamlLine, dataToI18n, genI18nFromSrc, argv, destFolder, format, slice$ = [].slice;
ref$ = require('prelude-ls'), reject = ref$.reject, each = ref$.each, keys = ref$.keys, map = ref$.map, elemIndex = ref$.elemIndex, findIndex = ref$.findIndex, join = ref$.join, isType = ref$.isType, compact = ref$.compact, concat = ref$.concat;
range = require('lodash').range;
ref$ = require('../package'), name = ref$.name, version = ref$.version;
fs = require('fs');
download = require('download');
mkdirp = require('mkdirp');
xlsxToJson = require('node-excel-to-json');
Excel = require('exceljs');
msg = function(m){
  return console.log(name + " (" + version + "): " + m);
};
readSpreadsheet = function(filePath){
  var wb;
  wb = new Excel.Workbook();
  return wb.xlsx.readFile(filePath).then(function(){
    var ws, rowCount, colCount, result;
    ws = wb.getWorksheet(1);
    rowCount = ws.actualRowCount;
    colCount = ws.actualColumnCount;
    return result = range(1, rowCount + 1).map(function(i){
      return ws.getRow(i)._cells.splice(0, colCount).map(function(c){
        return c.value;
      });
    });
  })['catch'](function(reason){
    return reason;
  });
};
composeYamlLine = function(lineItems, valCol){
  var keyIndex, indentNKey, value, line;
  keyIndex = findIndex(function(it){
    return it !== null && it !== undefined && it !== '';
  })(
  lineItems);
  if (!isType('Undefined', keyIndex)) {
    indentNKey = repeatString$('  ', keyIndex) + "" + lineItems[keyIndex];
    value = lineItems[valCol];
    if (/^[\{\[]/.test(value)) {
      value = "'" + value + "'";
    }
    return line = (indentNKey + ":") + (value ? " " + value : '');
  }
};
dataToI18n = function(dataRows, destFolder, format){
  var header, rows, locales, headerItems, prefixKeys;
  header = dataRows[0], rows = slice$.call(dataRows, 1);
  locales = {};
  headerItems = header;
  each(function(it){
    if (it !== null && it !== undefined && it !== '' && it !== '#' && it !== 'remark') {
      return locales[it] = elemIndex(it, headerItems);
    }
  })(
  headerItems);
  switch (false) {
  case format !== 'yaml' && format !== 'yml':
    msg("Generating " + format + " files ...");
    return each(function(lang){
      var yamlRows, outFilePath;
      yamlRows = join('\n')(
      map(function(line){
        return composeYamlLine(line, locales[lang]);
      })(
      rows));
      outFilePath = destFolder + "/" + lang + ".i18n.yml";
      msg("\t -> " + outFilePath);
      return fs.writeFileSync(outFilePath, yamlRows, {
        flag: 'w'
      });
    })(
    keys(
    locales));
  case !in$(format, ['json']):
    msg("Generating " + format + " files ...");
    prefixKeys = [];
    return each(function(lang){
      var jsonRows, jsonContent, outFilePath;
      jsonRows = join(',\n')(
      reject(function(it){
        return it === '';
      })(
      map(function(line){
        var jsonLine, lineItems, keyIndex, compactedItems, thisKey, thisValue;
        jsonLine = '';
        lineItems = line;
        keyIndex = findIndex(function(it){
          return it !== null && it !== undefined && it !== '';
        })(
        lineItems);
        compactedItems = compact(lineItems);
        if (keyIndex === 0) {
          prefixKeys = [];
        }
        if (compactedItems.length === 1) {
          prefixKeys[keyIndex] = compactedItems[0];
        }
        if (compactedItems.length > 0) {
          thisKey = compactedItems[0];
          thisValue = lineItems[locales[lang]].replace(/\"/gi, '\\"');
          if (compactedItems.length > 1) {
            jsonLine = "  \"" + join('.')(
            concat([prefixKeys, [thisKey]])) + "\" : \"" + thisValue + "\"";
          }
          if (compactedItems.length === 1) {
            jsonLine = "  \"" + join('.')(
            prefixKeys) + "\" : \"" + thisValue + "\"";
          }
        }
        return jsonLine;
      })(
      rows)));
      jsonContent = "{\n" + jsonRows + "\n}";
      outFilePath = destFolder + "/" + lang + ".json";
      msg("\t -> " + outFilePath);
      return fs.writeFileSync(outFilePath, jsonContent, {
        flag: 'w'
      });
    })(
    keys(
    locales));
  default:
    return msg("Unsupported format!");
  }
};
genI18nFromSrc = function(src, destFolder, format){
  src = src || '';
  destFolder = destFolder || '.';
  if (!src.trim()) {
    msg("No data source specified");
    return;
  }
  return mkdirp(destFolder.trim(), function(err){
    if (err) {
      return msg("Error creating destination folder: " + destFolder);
    } else {
      msg("Created destination folder: " + destFolder);
      if (/^http/.test(src.toLowerCase())) {
        msg("Using remote i18n source (assuming valid .TSV): " + src);
        return download(src).then(function(rawData){
          var dataTable;
          dataTable = rawData.toString().split('\r\n').map(function(line){
            return line.split('\t');
          });
          return dataToI18n(dataTable, destFolder, format);
        });
      } else {
        msg("Using local i18n source (assuming valid .XLSX): " + src);
        return readSpreadsheet(src).then(function(result){
          return dataToI18n(result, destFolder, format);
        })['catch'](function(reason){
          return console.log(reason);
        });
      }
    }
  });
};
argv = require('minimist')(process.argv.slice(2));
msg(JSON.stringify(argv));
destFolder = argv.p || '.';
format = argv.f || 'yml';
genI18nFromSrc(argv.s, destFolder, format);
function repeatString$(str, n){
  for (var r = ''; n > 0; (n >>= 1) && (str += str)) if (n & 1) r += str;
  return r;
}
function in$(x, xs){
  var i = -1, l = xs.length >>> 0;
  while (++i < l) if (x === xs[i]) return true;
  return false;
}
//# sourceMappingURL=data:application/json;base64,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QUEsTUFBQTtpQkFBWSxPQUFPLENBQUMsSUFBSSxNQUFBO1NBQXhCOzs7R0FuQmY7O0FBcUJKLElBQUssQ0FBQSxDQUFBLENBQUUsUUFBUSxVQUFELEVBQWEsT0FBTyxDQUFDLElBQUksQ0FBQyxNQUFNLENBQUQsQ0FBbkI7QUFDMUIsSUFBSSxJQUFJLENBQUMsVUFBVSxJQUFBLENBQWY7QUFDSixVQUFZLENBQUEsQ0FBQSxDQUFFLElBQUksQ0FBQyxDQUFFLENBQUEsRUFBQSxDQUFHO0FBQ3hCLE1BQU8sQ0FBQSxDQUFBLENBQUUsSUFBSSxDQUFDLENBQUUsQ0FBQSxFQUFBLENBQUc7QUFDbkIsZUFBa0IsSUFBSSxDQUFDLEdBQUcsWUFBYSxNQUFyQiIsInNvdXJjZXNDb250ZW50IjpbImBgIyEvdXNyL2Jpbi9lbnYgbm9kZWBgXG5cbnsgcmVqZWN0LCBlYWNoLCBrZXlzLCBtYXAsIGVsZW0taW5kZXgsIGZpbmQtaW5kZXgsIGpvaW4sIGlzLXR5cGUsIGNvbXBhY3QsIGNvbmNhdCB9ID0gcmVxdWlyZSAncHJlbHVkZS1scydcbnsgcmFuZ2UgfSA9IHJlcXVpcmUgJ2xvZGFzaCdcbnsgbmFtZSwgdmVyc2lvbiB9ID0gcmVxdWlyZSAnLi4vcGFja2FnZSdcbmZzID0gcmVxdWlyZSAnZnMnXG5kb3dubG9hZCA9IHJlcXVpcmUgJ2Rvd25sb2FkJ1xubWtkaXJwID0gcmVxdWlyZSAnbWtkaXJwJ1xueGxzeC10by1qc29uID0gcmVxdWlyZSAnbm9kZS1leGNlbC10by1qc29uJ1xuRXhjZWwgPSByZXF1aXJlICdleGNlbGpzJ1xuXG5tc2cgPSAobSkgLT4gY29uc29sZS5sb2cgXCIje25hbWV9ICgje3ZlcnNpb259KTogI3ttfVwiXG4jIGV4Y2VsLXNhbXBsZS1maWxlID0gJy4vdGVzdC9kYXRhLXNvdXJjZS9pMThuLWdlbi1zYW1wbGUtc291cmNlLnhsc3gnXG5cbnJlYWQtc3ByZWFkc2hlZXQgPSAoZmlsZS1wYXRoKSAtPlxuICB3YiA9IG5ldyBFeGNlbC5Xb3JrYm9vayFcbiAgd2IueGxzeC5yZWFkLWZpbGUgZmlsZS1wYXRoXG4gICAgLnRoZW4gLT5cbiAgICAgIHdzID0gd2IuZ2V0LXdvcmtzaGVldCgxKVxuICAgICAgcm93LWNvdW50ID0gd3MuYWN0dWFsLXJvdy1jb3VudFxuICAgICAgY29sLWNvdW50ID0gd3MuYWN0dWFsLWNvbHVtbi1jb3VudFxuICAgICAgIyBjb25zb2xlLmxvZyBcImFjdHVhbFJvd0NvdW50IC8gYWN0dWFsQ29sdW1uQ291bnQ6ICN7cm93LWNvdW50fSAvICN7Y29sLWNvdW50fVwiXG4gICAgICByZXN1bHQgPSByYW5nZSgxLCByb3ctY291bnQgKyAxKVxuICAgICAgICAubWFwKChpKSAtPiB3cy5nZXQtcm93KGkpLl9jZWxscy5zcGxpY2UoMCwgY29sLWNvdW50KS5tYXAoKGMpIC0+IGMudmFsdWUpKVxuICAgICAgIyBjb25zb2xlLmxvZyByZXN1bHRcbiAgICAuY2F0Y2ggKHJlYXNvbikgLT4gcmVhc29uXG5cbmNvbXBvc2UteWFtbC1saW5lID0gKGxpbmUtaXRlbXMsIHZhbC1jb2wpIC0+XG4gICMgY29uc29sZS5sb2cgXCJsaW5lLWl0ZW1zOiAje0pTT04uc3RyaW5naWZ5KGxpbmUtaXRlbXMpfVwiXG4gICMgZmluZCAxc3Qgbm9uLWVtcHR5IGNvbHVtbiBvZiB0aGUgbGluZS5cbiAgIyB3aGljaCBpcyB0aGUga2V5LWluZGV4IG9mIHRoZSBjb3JyZXNwb25kaW5nIHlhbWwgbGluZVxuICBrZXktaW5kZXggPSBsaW5lLWl0ZW1zIHw+IGZpbmQtaW5kZXggLT4gaXQgbm90IGluIFsgbnVsbCwgdW5kZWZpbmVkLCAnJyBdXG4gIHVubGVzcyBpcy10eXBlICdVbmRlZmluZWQnLCBrZXktaW5kZXhcbiAgICBpbmRlbnQtbi1rZXkgPSBcIiN7JyAgJyAqIGtleS1pbmRleH0je2xpbmUtaXRlbXNba2V5LWluZGV4XX1cIlxuICAgICMgdmFsdWUgPSBsaW5lLWl0ZW1zW2xvY2FsZXNbbGFuZ11dLnJlcGxhY2UoL1xcXCIvZ2ksJ1xcXFxcXFwiJylcbiAgICB2YWx1ZSA9IGxpbmUtaXRlbXNbdmFsLWNvbF1cbiAgICBpZiAvXltcXHtcXFtdLy50ZXN0KHZhbHVlKSAjIGhhbmRsZXMgdmFsdWUgc3RhcnRpbmcgd2l0aCBzcGVjaWFsIHlhbWwgY2hhcmFjdGVyXG4gICAgICB2YWx1ZSA9IFwiJyN7dmFsdWV9J1wiICMgYWRkIHNpbmdsZSBxdW90ZVxuICAgIGxpbmUgPSBcIiN7aW5kZW50LW4ta2V5fTpcIiArIChpZiB2YWx1ZSB0aGVuIFwiICN7dmFsdWV9XCIgZWxzZSAnJylcblxuZGF0YS10by1pMThuID0gKGRhdGEtcm93cywgZGVzdC1mb2xkZXIsIGZvcm1hdCkgLT5cbiAgIyBjb25zb2xlLmxvZyBkYXRhLXJvd3NcbiAgWyBoZWFkZXIsIC4uLnJvd3MgXSA9IGRhdGEtcm93c1xuICBsb2NhbGVzID0ge30gIyBlLmcuIHsnZW4nOjMsICd6aCc6NH1cbiAgIyBoZWFkZXItaXRlbXMgPSBoZWFkZXIuc3BsaXQgJ1xcdCdcbiAgaGVhZGVyLWl0ZW1zID0gaGVhZGVyXG4gIGhlYWRlci1pdGVtcyB8PiBlYWNoIC0+XG4gICAgaWYgKGl0IG5vdCBpbiBbIG51bGwsIHVuZGVmaW5lZCwgJycgJyMnICdyZW1hcmsnXSlcbiAgICAgIGxvY2FsZXNbaXRdID0gZWxlbS1pbmRleCBpdCwgaGVhZGVyLWl0ZW1zXG5cbiAgc3dpdGNoXG4gIGNhc2UgZm9ybWF0IGluIFsneWFtbCcsICd5bWwnXVxuICAgIG1zZyBcIkdlbmVyYXRpbmcgI3tmb3JtYXR9IGZpbGVzIC4uLlwiXG4gICAgbG9jYWxlcyB8PiBrZXlzIHw+IGVhY2ggKGxhbmcpIC0+XG4gICAgICB5YW1sLXJvd3MgPSByb3dzXG4gICAgICAgICAgICAgICAgfD4gbWFwIChsaW5lKSAtPlxuICAgICAgICAgICAgICAgICAgICBjb21wb3NlLXlhbWwtbGluZSBsaW5lLCBsb2NhbGVzW2xhbmddXG4gICAgICAgICAgICAgICAgfD4gam9pbiAnXFxuJ1xuICAgICAgb3V0LWZpbGUtcGF0aCA9IFwiI3tkZXN0LWZvbGRlcn0vI3tsYW5nfS5pMThuLnltbFwiXG4gICAgICBtc2cgXCJcXHQgLT4gI3tvdXQtZmlsZS1wYXRofVwiXG4gICAgICBmcyAud3JpdGUtZmlsZS1zeW5jIG91dC1maWxlLXBhdGgsIHlhbWwtcm93cywgeyBmbGFnOiAndyd9XG5cbiAgY2FzZSBmb3JtYXQgaW4gWydqc29uJ11cbiAgICBtc2cgXCJHZW5lcmF0aW5nICN7Zm9ybWF0fSBmaWxlcyAuLi5cIlxuICAgIHByZWZpeC1rZXlzID0gW11cbiAgICBsb2NhbGVzIHw+IGtleXMgfD4gZWFjaCAobGFuZykgLT5cbiAgICAgIGpzb24tcm93cyA9IHJvd3NcbiAgICAgICAgICAgICAgICB8PiBtYXAgKGxpbmUpIC0+XG4gICAgICAgICAgICAgICAgICAgIGpzb24tbGluZSA9ICcnXG4gICAgICAgICAgICAgICAgICAgIGxpbmUtaXRlbXMgPSBsaW5lXG4gICAgICAgICAgICAgICAgICAgICMgZmluZCAxc3Qgbm9uLWVtcHR5IGNvbHVtbiBvZiB0aGUgbGluZS5cbiAgICAgICAgICAgICAgICAgICAgIyB3aGljaCBpcyB0aGUga2V5LWluZGV4IG9mIHRoZSBjb3JyZXNwb25kaW5nIHlhbWwgbGluZVxuICAgICAgICAgICAgICAgICAgICBrZXktaW5kZXggPSBsaW5lLWl0ZW1zIHw+IGZpbmQtaW5kZXggLT4gaXQgbm90IGluIFsgbnVsbCwgdW5kZWZpbmVkLCAnJyBdXG4gICAgICAgICAgICAgICAgICAgIGNvbXBhY3RlZC1pdGVtcyA9IGNvbXBhY3QobGluZS1pdGVtcylcbiAgICAgICAgICAgICAgICAgICAgaWYga2V5LWluZGV4ID09IDAgIyB0b3AgbGV2ZWwga2V5XG4gICAgICAgICAgICAgICAgICAgICAgcHJlZml4LWtleXMgOj0gW10gIyByZXNldCBwcmVmaXgta2V5cyBhcnJheVxuICAgICAgICAgICAgICAgICAgICBpZiBjb21wYWN0ZWQtaXRlbXMubGVuZ3RoID09IDEgIyBsaW5lIHdpdGggb25seSBvbmUgcHJlZml4LWtleVxuICAgICAgICAgICAgICAgICAgICAgIHByZWZpeC1rZXlzW2tleS1pbmRleF0gPSBjb21wYWN0ZWQtaXRlbXNbMF0gIyByZXBsYWNlIHByZWZpeC1rZXlzXG4gICAgICAgICAgICAgICAgICAgIGlmIGNvbXBhY3RlZC1pdGVtcy5sZW5ndGggPiAwICMgbGluZSBjb250YWluaW5nIGxlYXZlIGxldmVsIGtleSBhbmQgbGFuZyB2YWx1ZVxuICAgICAgICAgICAgICAgICAgICAgIHRoaXMta2V5ID0gY29tcGFjdGVkLWl0ZW1zWzBdXG4gICAgICAgICAgICAgICAgICAgICAgdGhpcy12YWx1ZSA9IGxpbmUtaXRlbXNbbG9jYWxlc1tsYW5nXV0ucmVwbGFjZSgvXFxcIi9naSwnXFxcXFxcXCInKSAjIGVzY2FwZSBkb3VibGUgcXVvdGUgJ1wiJ1xuICAgICAgICAgICAgICAgICAgICAgIGlmIGNvbXBhY3RlZC1pdGVtcy5sZW5ndGggPiAxIHRoZW5cbiAgICAgICAgICAgICAgICAgICAgICAgIGpzb24tbGluZSA6PSBcIiAgXFxcIiN7KCBjb25jYXQgWyBwcmVmaXgta2V5cywgWyB0aGlzLWtleSBdIF0gfD4gam9pbiAnLicgKX1cXFwiIDogXFxcIiN7dGhpcy12YWx1ZX1cXFwiXCJcbiAgICAgICAgICAgICAgICAgICAgICAjIGhhbmRsZXMgZW1wdHkgdHJhbnNsYXRpb24gdmFsdWVcbiAgICAgICAgICAgICAgICAgICAgICBpZiBjb21wYWN0ZWQtaXRlbXMubGVuZ3RoID09IDEgdGhlblxuICAgICAgICAgICAgICAgICAgICAgICAganNvbi1saW5lIDo9IFwiICBcXFwiI3soIHByZWZpeC1rZXlzIHw+IGpvaW4gJy4nICl9XFxcIiA6IFxcXCIje3RoaXMtdmFsdWV9XFxcIlwiXG4gICAgICAgICAgICAgICAgICAgIHJldHVybiBqc29uLWxpbmVcbiAgICAgICAgICAgICAgICB8PiByZWplY3QgLT4gaXQgPT0gJycgIyByZW1vdmUgZW1wdHkgcm93c1xuICAgICAgICAgICAgICAgIHw+IGpvaW4gJyxcXG4nXG4gICAgICBqc29uLWNvbnRlbnQgPSBcIntcXG4je2pzb24tcm93c31cXG59XCJcbiAgICAgIG91dC1maWxlLXBhdGggPSBcIiN7ZGVzdC1mb2xkZXJ9LyN7bGFuZ30uanNvblwiXG4gICAgICBtc2cgXCJcXHQgLT4gI3tvdXQtZmlsZS1wYXRofVwiXG4gICAgICBmcyAud3JpdGUtZmlsZS1zeW5jIG91dC1maWxlLXBhdGgsIGpzb24tY29udGVudCwgeyBmbGFnOiAndyd9XG5cbiAgZGVmYXVsdFxuICAgIG1zZyBcIlVuc3VwcG9ydGVkIGZvcm1hdCFcIlxuXG5nZW4taTE4bi1mcm9tLXNyYyA9IChzcmMsIGRlc3QtZm9sZGVyLCBmb3JtYXQpIC0+XG4gIHNyYyA9IHNyYyB8fCAnJ1xuICBkZXN0LWZvbGRlciA9IGRlc3QtZm9sZGVyIHx8ICcuJ1xuICBpZiBub3Qgc3JjLnRyaW0hXG4gICAgbXNnIFwiTm8gZGF0YSBzb3VyY2Ugc3BlY2lmaWVkXCJcbiAgICByZXR1cm5cbiAgbWtkaXJwIGRvICMgZW5zdXJlIGRlc3QtZm9sZGVyIGV4aXN0ZW5jZVxuICAgIGRlc3QtZm9sZGVyLnRyaW0hXG4gICAgKGVycikgLT5cbiAgICAgIGlmIChlcnIpXG4gICAgICAgIG1zZyBcIkVycm9yIGNyZWF0aW5nIGRlc3RpbmF0aW9uIGZvbGRlcjogI3tkZXN0LWZvbGRlcn1cIlxuICAgICAgZWxzZVxuICAgICAgICBtc2cgXCJDcmVhdGVkIGRlc3RpbmF0aW9uIGZvbGRlcjogI3tkZXN0LWZvbGRlcn1cIlxuICAgICAgICBpZiAvXmh0dHAvLnRlc3Qgc3JjLnRvLWxvd2VyLWNhc2UhXG4gICAgICAgICAgbXNnIFwiVXNpbmcgcmVtb3RlIGkxOG4gc291cmNlIChhc3N1bWluZyB2YWxpZCAuVFNWKTogI3tzcmN9XCJcbiAgICAgICAgICBkb3dubG9hZCBzcmNcbiAgICAgICAgICAgIC50aGVuIChyYXctZGF0YSkgLT5cbiAgICAgICAgICAgICAgIyBhc3N1bWluZyByYXctZGF0YSBpcyB2YWxpZCAudHN2IGZvcm1hdFxuICAgICAgICAgICAgICAjIHRyYW5zZm9ybSB0byBhcnJheSBvZiBhcnJheVxuICAgICAgICAgICAgICBkYXRhLXRhYmxlID0gcmF3LWRhdGEudG8tc3RyaW5nIXNwbGl0KCdcXHJcXG4nKVxuICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgICAgIC5tYXAgKGxpbmUpIC0+IGxpbmUuc3BsaXQoJ1xcdCcpXG4gICAgICAgICAgICAgIGRhdGEtdG8taTE4biBkYXRhLXRhYmxlLCBkZXN0LWZvbGRlciwgZm9ybWF0XG4gICAgICAgIGVsc2VcbiAgICAgICAgICBtc2cgXCJVc2luZyBsb2NhbCBpMThuIHNvdXJjZSAoYXNzdW1pbmcgdmFsaWQgLlhMU1gpOiAje3NyY31cIlxuICAgICAgICAgIHJlYWQtc3ByZWFkc2hlZXQgc3JjXG4gICAgICAgICAgICAudGhlbiAocmVzdWx0KSAtPiBkYXRhLXRvLWkxOG4gcmVzdWx0LCBkZXN0LWZvbGRlciwgZm9ybWF0XG4gICAgICAgICAgICAuY2F0Y2ggKHJlYXNvbikgLT4gY29uc29sZS5sb2cgcmVhc29uXG5cbmFyZ3YgPSByZXF1aXJlKCdtaW5pbWlzdCcpKHByb2Nlc3MuYXJndi5zbGljZSgyKSlcbm1zZyBKU09OLnN0cmluZ2lmeSBhcmd2XG5kZXN0LWZvbGRlciA9IGFyZ3YucCB8fCAnLidcbmZvcm1hdCA9IGFyZ3YuZiB8fCAneW1sJyAjICd5bWwnIChkZWZhdWx0KSBvciAnanNvbidcbmdlbi1pMThuLWZyb20tc3JjIGFyZ3YucywgZGVzdC1mb2xkZXIsIGZvcm1hdFxuIl19
